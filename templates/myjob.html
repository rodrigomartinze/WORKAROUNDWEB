{% extends "base.html" %}

{% block title %}Mis Solicitudes - WorkAround{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/myjob.css">
{% endblock %}

{% block content %}
<div class="myjob-container">
    <!-- SIDEBAR -->
    <div class="myjob-sidebar">
        <div style="margin-bottom: 2rem;">
            <h3 class="sidebar-title">Filtrar por Estado</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button class="filter-btn active" onclick="filtrarPorEstado('todas')" data-filter="todas">
                    üìã Todas (<span id="count-todas">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarPorEstado('en_espera')" data-filter="en_espera">
                    ‚è± Pendientes (<span id="count-en_espera">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarPorEstado('aceptado')" data-filter="aceptado">
                    ‚úì Aceptadas (<span id="count-aceptado">0</span>)
                </button>
                <button class="filter-btn" onclick="filtrarPorEstado('rechazado')" data-filter="rechazado">
                    ‚úï Rechazadas (<span id="count-rechazado">0</span>)
                </button>
            </div>
        </div>

        <h3 class="sidebar-title">Mis Solicitudes</h3>
        <div class="jobs-list" id="jobsList">
            <!-- Las solicitudes se cargar√°n aqu√≠ din√°micamente -->
        </div>

        <div id="noSolicitudes" style="display: none; text-align: center; padding: 2rem; color: #718096;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
            <p>No tienes solicitudes</p>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="myjob-content" id="detailContent">
        <div class="empty-state">
            <p>Selecciona una solicitud de la izquierda para ver los detalles</p>
        </div>
    </div>
</div>

<script>
    let aplicaciones = [];
    let filtroActual = 'todas';
    let aplicacionSeleccionada = null;

    // Cargar aplicaciones al iniciar
    document.addEventListener('DOMContentLoaded', () => {
        cargarAplicaciones();
    });

    // Cargar aplicaciones del usuario
    async function cargarAplicaciones() {
        try {
            const response = await fetch('/get_mis_aplicaciones');
            const data = await response.json();

            if (data.success) {
                aplicaciones = data.aplicaciones;
                actualizarContadores();
                renderizarListaSolicitudes();

                // Seleccionar la primera si existe
                if (aplicaciones.length > 0) {
                    mostrarDetalle(aplicaciones[0].AplicacionId);
                }
            } else {
                console.error('Error al cargar aplicaciones:', data.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Actualizar contadores de estado
    function actualizarContadores() {
        const counts = {
            todas: aplicaciones.length,
            en_espera: aplicaciones.filter(a => a.Estado === 'en_espera').length,
            aceptado: aplicaciones.filter(a => a.Estado === 'aceptado').length,
            rechazado: aplicaciones.filter(a => a.Estado === 'rechazado').length
        };

        Object.keys(counts).forEach(estado => {
            const element = document.getElementById(`count-${estado}`);
            if (element) element.textContent = counts[estado];
        });
    }

    // Filtrar por estado
    function filtrarPorEstado(estado) {
        filtroActual = estado;

        // Actualizar botones activos
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${estado}"]`).classList.add('active');

        // Renderizar lista filtrada
        renderizarListaSolicitudes();
    }

    // Renderizar lista de solicitudes
    function renderizarListaSolicitudes() {
        const jobsList = document.getElementById('jobsList');
        const noSolicitudes = document.getElementById('noSolicitudes');

        // Filtrar aplicaciones
        let aplicacionesFiltradas = aplicaciones;
        if (filtroActual !== 'todas') {
            aplicacionesFiltradas = aplicaciones.filter(a => a.Estado === filtroActual);
        }

        if (aplicacionesFiltradas.length === 0) {
            jobsList.innerHTML = '';
            noSolicitudes.style.display = 'block';
            document.getElementById('detailContent').innerHTML = `
                <div class="empty-state">
                    <p>No hay solicitudes para mostrar con este filtro</p>
                </div>
            `;
            return;
        }

        noSolicitudes.style.display = 'none';

        jobsList.innerHTML = aplicacionesFiltradas.map(app => {
            const estadoInfo = getEstadoInfo(app.Estado);
            const isActive = aplicacionSeleccionada === app.AplicacionId ? 'active' : '';

            return `
                <div class="job-item ${isActive}" onclick="mostrarDetalle(${app.AplicacionId})" data-id="${app.AplicacionId}">
                    <h4>${app.VacanteTitulo}</h4>
                    <p>${app.NombreEmpresa}</p>
                    <span class="status-badge ${app.Estado}">${estadoInfo.icon} ${estadoInfo.texto}</span>
                </div>
            `;
        }).join('');
    }

    // Obtener informaci√≥n del estado
    function getEstadoInfo(estado) {
        const estados = {
            'en_espera': { icon: '‚è±', texto: 'En Espera' },
            'aceptado': { icon: '‚úì', texto: 'Aceptado' },
            'rechazado': { icon: '‚úï', texto: 'Rechazado' }
        };
        return estados[estado] || estados['en_espera'];
    }

    // Mostrar detalle de una solicitud
    function mostrarDetalle(aplicacionId) {
        aplicacionSeleccionada = aplicacionId;
        const app = aplicaciones.find(a => a.AplicacionId === aplicacionId);

        if (!app) return;

        // Actualizar clases activas
        document.querySelectorAll('.job-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`[data-id="${aplicacionId}"]`)?.classList.add('active');

        const estadoInfo = getEstadoInfo(app.Estado);
        const detailContent = document.getElementById('detailContent');

        detailContent.innerHTML = `
            <div class="solicitud-detail">
                <div class="solicitud-header">
                    <div class="solicitud-icon">üíº</div>
                    <div class="solicitud-header-text">
                        <h2>${app.VacanteTitulo}</h2>
                        <p>${app.NombreEmpresa}</p>
                        <div class="status-container ${app.Estado}">
                            <span class="status-icon">${estadoInfo.icon}</span>
                            <span class="status-text">${estadoInfo.texto}</span>
                        </div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-box">
                        <h3>Estado de Solicitud</h3>
                        <p>${estadoInfo.texto}</p>
                    </div>
                    <div class="info-box">
                        <h3>Fecha de Aplicaci√≥n</h3>
                        <p>${app.FechaAplicacion}</p>
                    </div>
                    <div class="info-box">
                        <h3>Ubicaci√≥n</h3>
                        <p>${app.Ubicacion || 'No especificada'}</p>
                    </div>
                    <div class="info-box">
                        <h3>Tipo de Trabajo</h3>
                        <p>${app.TipoTrabajo || 'No especificado'}</p>
                    </div>
                </div>

                ${app.SalarioMin && app.SalarioMax ? `
                    <div class="company-section">
                        <h3>üí∞ Rango Salarial</h3>
                        <div style="font-size: 1.5rem; color: #667eea; font-weight: 700; margin-top: 1rem;">
                            $${Number(app.SalarioMin).toLocaleString()} - $${Number(app.SalarioMax).toLocaleString()}
                        </div>
                    </div>
                ` : ''}

                <div class="company-section">
                    <h3>üìã Informaci√≥n de la Empresa</h3>
                    <div class="company-info">
                        <div class="company-detail">
                            <label>Empresa</label>
                            <p>${app.NombreEmpresa}</p>
                        </div>
                        <div class="company-detail">
                            <label>Ciudad</label>
                            <p>${app.CiudadEmpresa || 'No especificada'}</p>
                        </div>
                        ${app.Descripcion ? `
                            <div class="company-detail full">
                                <label>Descripci√≥n del Puesto</label>
                                <p>${app.Descripcion}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>

                ${app.Estado === 'aceptado' ? `
                    <div style="background: #d1fae5; border: 2px solid #22c55e; border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéâ</div>
                        <h3 style="color: #065f46; margin-bottom: 0.5rem;">¬°Felicidades!</h3>
                        <p style="color: #065f46;">Tu solicitud ha sido aceptada. La empresa se pondr√° en contacto contigo pronto.</p>
                    </div>
                ` : ''}

                ${app.Estado === 'rechazado' ? `
                    <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üòî</div>
                        <h3 style="color: #991b1b; margin-bottom: 0.5rem;">Solicitud Rechazada</h3>
                        <p style="color: #991b1b;">Lo sentimos, en esta ocasi√≥n tu perfil no fue seleccionado. Sigue buscando nuevas oportunidades.</p>
                    </div>
                ` : ''}
            </div>
        `;
    }
</script>
{% endblock %}